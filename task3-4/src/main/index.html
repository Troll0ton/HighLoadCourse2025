<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>gRPC Web Messenger</title>
    <script src="https://unpkg.com/@improbable-eng/grpc-web"></script>
    <script type="module">
        import {grpc} from "https://cdn.skypack.dev/@improbable-eng/grpc-web";
        import {MessengerService} from "./generated/messenger_pb_service.js";
        import {MessageRequest, ReceiveRequest} from "./generated/messenger_pb.js";

        const host = "http://localhost:8080";

        const nickname = prompt("Enter your nickname:");
        const receiveClient = grpc.client(MessengerService.ReceiveMessages, {
            host
        });

        receiveClient.onMessage(msg => {
            const box = document.getElementById("messages");
            const div = document.createElement("div");
            div.innerHTML = `<b>${msg.getFrom()}</b>: ${msg.getContent()}`;
            box.appendChild(div);
        });

        receiveClient.start();
        const req = new ReceiveRequest();
        req.setUsername(nickname);
        receiveClient.send(req);

        document.getElementById("send").onclick = () => {
            const to = document.getElementById("to").value;
            const content = document.getElementById("content").value;

            const msg = new MessageRequest();
            msg.setFrom(nickname);
            msg.setTo(to);
            msg.setContent(content);

            grpc.unary(MessengerService.SendMessage, {
                request: msg,
                host,
                onEnd: res => console.log(res.status)
            });
        };
    </script>
</head>
<body>
<h2>gRPC Web Chat</h2>
<div id="messages" style="border:1px solid #ccc; height:200px; overflow:auto; padding:5px;"></div>
<input id="to" placeholder="To"><br>
<textarea id="content" placeholder="Message"></textarea><br>
<button id="send">Send</button>
</body>
</html>
